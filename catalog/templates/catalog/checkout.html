{% extends 'catalog/base.html' %}
{% load static %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
{% endblock %}

{% block content %}
<div class="checkout-container">
    <div class="checkout-header">
        <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>
        <div class="checkout-steps">
            <div class="step active">
                <span class="step-number">1</span>
                <span class="step-text">–ö–æ—Ä–∑–∏–Ω–∞</span>
            </div>
            <span class="step-connector"></span>
            <div class="step active">
                <span class="step-number">2</span>
                <span class="step-text">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</span>
            </div>
            <span class="step-connector"></span>
            <div class="step">
                <span class="step-number">3</span>
                <span class="step-text">–ì–æ—Ç–æ–≤–æ</span>
            </div>
        </div>
    </div>

    

        <div class="order-summary">
            <div class="summary-header">
                <h2>–í–∞—à –∑–∞–∫–∞–∑</h2>
                <a href="/" class="edit-order">–ò–∑–º–µ–Ω–∏—Ç—å</a>
            </div>
            
            <div class="summary-items">
                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã -->
            </div>
            
            <div class="summary-totals">
                <div class="summary-row">
                    <span>–¢–æ–≤–∞—Ä—ã</span>
                    <span id="subtotal">0 —Ç–≥.</span>
                </div>
                <div class="summary-row">
                    <span>–î–æ—Å—Ç–∞–≤–∫–∞</span>
                    <span id="delivery-cost">0 —Ç–≥.</span>
                </div>
                <div class="summary-row total">
                    <span>–ò—Ç–æ–≥–æ</span>
                    <span id="total">0 —Ç–≥.</span>
                </div>
            </div>
            
            <a id="whatsapp-order-button" style="margin-left: -15px;" href="#" class="place-order-button">
                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑
            </a>
            
            <div class="order-note">
                <p>–ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑", –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å <a href="#">—É—Å–ª–æ–≤–∏—è–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</a>.</p>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –∏–∑ localStorage
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const summaryItems = document.querySelector('.summary-items');
        const subtotalEl = document.getElementById('subtotal');
        const deliveryCostEl = document.getElementById('delivery-cost');
        const totalEl = document.getElementById('total');
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
        let subtotal = 0;
        let deliveryCost = 0;
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –≤ —Å–≤–æ–¥–∫–µ –∑–∞–∫–∞–∑–∞
        cart.forEach(item => {
            const itemTotal = item.price * (item.quantity || 1);
            subtotal += parseFloat(itemTotal);
            
            const itemElement = document.createElement('div');
            itemElement.className = 'summary-item';
            itemElement.innerHTML = `
                <div class="item-image">
                    <img src="${item.image}" alt="${item.name}">
                </div>
                <div class="item-details">
                    <h3>${item.name}</h3>
                    <p>${item.volumeLabel || (item.volume + ' –º–ª')}</p>
                    <div class="item-quantity-price">
                        <span>${item.quantity || 1} √ó ${item.price} —Ç–≥.</span>
                    </div>
                </div>
                <div class="item-total">
                    ${itemTotal} —Ç–≥.
                </div>
            `;
            
            summaryItems.appendChild(itemElement);
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—É–º–º
        subtotalEl.textContent = subtotal.toFixed(0) + ' —Ç–≥.';
        updateTotal();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
        const deliveryOptions = document.querySelectorAll('input[name="delivery"]');
        const addressForm = document.getElementById('address-form');
        
        deliveryOptions.forEach(option => {
            option.addEventListener('change', function() {
                if (this.value === 'courier') {
                    addressForm.style.display = 'block';
                    deliveryCost = 1500;
                } else {
                    addressForm.style.display = 'none';
                    deliveryCost = 0;
                }
                deliveryCostEl.textContent = deliveryCost + ' —Ç–≥.';
                updateTotal();
            });
        });
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã
        function updateTotal() {
            const total = subtotal + deliveryCost;
            totalEl.textContent = total.toFixed(0) + ' —Ç–≥.';
            return total;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ –∑–∞–∫–∞–∑–∞ –¥–ª—è WhatsApp
        function generateOrderMessage() {
            let message = "üõí *–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞ Sultanbi Perfumes* üõí\n\n";
            message += "*–¢–æ–≤–∞—Ä—ã:*\n";
            
            cart.forEach((item, index) => {
                const quantity = item.quantity || 1;
                const itemTotal = item.price * quantity;
                message += `${index + 1}. ${item.name} (${item.volumeLabel || item.volume + ' –º–ª'}) - ${quantity} —à—Ç √ó ${item.price} —Ç–≥ = ${itemTotal} —Ç–≥\n`;
            });
            
            const totalAmount = updateTotal();
            
            message += "\n*–û–±—â–∞—è —Å—É–º–º–∞:* " + totalAmount + " —Ç–≥";
            message += "\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –º–æ–π –∑–∞–∫–∞–∑. –°–ø–∞—Å–∏–±–æ!";
            
            return encodeURIComponent(message);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫–µ –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ WhatsApp
        document.getElementById('whatsapp-order-button').addEventListener('click', function(e) {
            e.preventDefault();
            
            if (cart.length === 0) {
                alert('–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –ø–µ—Ä–µ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞.');
                return;
            }
            
            const orderMessage = generateOrderMessage();
            const whatsappLink = `https://wa.me/7754332453?text=${orderMessage}`;
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º WhatsApp —Å –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            window.open(whatsappLink, '_blank');
            
            // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞
            localStorage.removeItem('cart');
            
            // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            setTimeout(() => {
                alert('–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WhatsApp.');
                window.location.href = '/';
            }, 1000);
        });
    });
</script>
{% endblock %}
